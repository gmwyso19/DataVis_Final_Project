---
title: "Final Project"
author: "Grace Wysocki"
date: "3/22/2022"
output: html_document
---

Direct information to use in my blog to talk about the data: 

The Safe Drinking Water Act requires EPA to administer a surveillance program to determine the prevalence of unregulated contaminants in finished water provided by community water systems. A number of states and individual public water systems have been testing source water and finished water for PFAS, but these records are not maintained by EPA in a national repository. EPA has provided states that are regulating and/or testing PFAS with a mechanism to store/report PFAS data that is associated with state-specific PFAS regulations. As of January 2021, EPA was able to compile data for eight states that have used EPA’s reporting module (SDWIS-State). The information is retrieved on a semi-annual basis – primarily from state web pages where the information is published. This data file includes aggregated data from multiple state sampling initiatives. These initiatives vary in sampling/targeting methods (e.g., non-targeted analysis vs. targeted analysis), scope (e.g., percentage and type of public water system), detection limits, sample location, reporting limits, quantification methods, what data elements are reported, and even what data are reported (e.g., some states choosing only to report detections while other states report all test results). Because of these significant differences in how states are collecting data, the information in this file should not be compared across state boundaries.

For this reason, I will be focusing on the state of California, as it had a lot of data collected.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("blogdown")
```

```{r}
library(readr)
library(tidyverse)
library(sf)
library(plotly)
library(ggplot2)
Drinking_Water <- read_csv("~/Desktop/Drinking_Water_Testing_Data_State_01-03-2022_0.csv")
#view(Drinking_Water)
```

Tidying the data set to specify it to only include points from California of PFOA during the year 2020.
```{r}
Water_CA <- Drinking_Water %>% group_by(State) %>% filter(State =="CA")
Water_CA <- Water_CA %>% rename(Sample_Date = `Sample Date`) %>% separate(col = Sample_Date, into = c("month", "day", "year"), 
           sep = "/") 
##view(Water_CA)
Water_CA <- Water_CA %>% group_by(year, Contaminant) %>% filter(year == 2020) %>% filter(Contaminant == "PFOA") 
#(Water_CA)
```

Working Lollipop Graph Showing Average Concentrations Drawn in Each County During the Month of January in 2020.
```{r}

Water_AVG <- Water_CA %>% ungroup() %>% group_by(County) %>% summarise(Concentration_Total = mean(Concentration)) %>% filter(Concentration_Total > 2) %>% arrange(desc(Concentration_Total)) 

#view(Water_AVG)

Water_remove <- Water_AVG[-c(16), ]

#view(Water_remove)

Water_facter <- Water_remove %>% select(County) %>%
  arrange(Concentration_Total) %>% mutate(County = factor(County, levels = .$County)) 

plot3 <- ggplot(data = Water_remove, aes(x = County, y = Concentration_Total)) +
  geom_point(size=3, color="blue", fill=alpha("light blue", 0.3), alpha=0.7, shape=21, stroke=1) + 
  geom_segment(aes(x = County, xend = County, y = 0, yend = Concentration_Total)) +
  coord_flip() +
  labs(x = "County Name", 
       y = "Average Concentrations of PFOA(NG/L) Drawn from Each County in January 2020")

ggplotly(plot3, tooltip = c("County")

```
WHY IS THIS NOT WORKING NOW!


Working Lollipop Graph of Populations of Each County During the Month of January in 2020.
```{r}
Water_parse <- Water_CA %>% rename(Population_Served = `Population Served`) %>% mutate(Population_Served = parse_number(Population_Served)) 

Water_parse <- Water_parse[-c(41, 127, 173, 174, 205), ]

#view(Water_parse)

Water_Parse <- Water_parse %>% group_by(County) %>% summarise(Population_AVG = mean(Population_Served)) %>% arrange(desc(Population_AVG))

 Water_Parse <- Water_Parse %>% select(County, Population_AVG) %>%
  arrange(Population_AVG) %>% mutate(County = factor(County, levels = .$County)) 

  plot2 <- ggplot(data = Water_Parse, aes(x = County, y = Population_AVG)) +
  geom_point(size=3, color="blue", fill=alpha("light blue", 0.3), alpha=0.7, shape=21, stroke=1) + 
  geom_segment(aes(x = County, xend = County, y = 0, yend = Population_AVG)) + coord_flip() +
  labs(x = "County Name", 
       y = "Population Each County Included in California in January 2020")
  
  ggplotly(plot2, tooltip = "Population_AVG")

```


```{r}

#install.packages("usmap")
library(usmap) 
library(ggplot2) 

plot_usmap(regions = "counties") + 
  theme(panel.background=element_blank())

plot_usmap(include = c("CA")) +
  labs(title = "California Mapping") +
  theme(panel.background = element_rect(color = "black"))

plot_usmap(data = Water_CA, values = "Concentration_Total", include = c("CA"), color = "blue") + 
  scale_fill_continuous(low = "white", high = "blue", name = "PFOA Concentration", label = scales::comma) + 
  labs(title = "California PFOA Mapping", subtitle = "Concentration of PFOA Water Contamination for California Counties in 2020") +
  theme(legend.position = "right")

```



Make a graph to compare these rankings to try and make a point about is population size has a correlation with PFOA contamination concentration amounts.
```{r}

Water_plot <- full_join(Water_remove, Water_Parse, by = c("County" = "County"))

Water_plot <- Water_plot[-c(33:41), ]

plot1 <- ggplot(data = Water_plot, aes(x = Concentration_Total, y = Population_AVG,
                                   color = County,      
                                   label = County)) +
  geom_point()

ggplotly(plot1, tooltip = "label")

#view(Water_rename)
```
There does not seem to be a correlation between population size and concentration of PFOA.

Yay! Finally found a data sate to join with my water one that contains U.S. county zipcodes. This did take about an hour and a half to find, so it took up the majority of my work time. 
```{r}
url <- "https://en.wikipedia.org/wiki/User:Michael_J/County_table"

library(tidyverse)
library(rvest)

h <- read_html(url)

tab <- h %>% html_nodes("table")

tab
county_coord <- tab[[1]] %>% html_table(fill = TRUE)

county_coord <- county_coord %>% rename(County = `County [2]`)
county_coord <- county_coord %>% filter(State == "CA")

#view(county_coord)

#view(Water_remove)

Water_remove <-  Water_remove %>% separate(col = County, into = c("County", "State"), 
           sep = ",")

Water_remove
```

Changing Row Names of Counties and Joining data sets
```{r}
county_coord$County = toupper(county_coord$County)
county_coord
Water_remove

Water_coord3 <- full_join(Water_remove, county_coord, by = c("County" = "County"), copy = TRUE)

view(Water_coord3)

```

```{r}
library(plotly)
library(dplyr)
Water_remove
plot_geo(Water_remove,
         locationmode = 'USA-counties') %>% 
  add_trace(location = ~State,
            z = ~Concentration_Total,
            color = ~Concentration_Total) %>% 
  layout(geo = list(scope = 'usa'))
```


Have them joined but need to figure out how to change the row names of the counties so that they are not all in upper case. Once they are joined fully,I will be able to make my interactive leaflet map which will be my main data visualization for my blog.

Interactive Leaflet Map of California
Trying to make interactive map(using leaflet)

```{r}
library(ggplot2)
library(leaflet)
library(dplyr)

Water_coord2

Water_coord2 <- Water_coord3 %>% slice(1:21)
#view(Water_coord2)

leaflet(data = Water_coord2) %>% addProviderTiles('CartoDB') %>%
setView(lng = -119.4179, lat = 36.7783, zoom = 4.5) %>% addTiles() %>% addMarkers(lng = ~Longitude,
                                                                                  lat = ~ Latitude,
                                                                                  label = ~County)

```


```{r}
library(plotly)

Water_coord2 <- Water_coord2 %>% rename(Population = `Population(2010)`)

Water_coord2

Water_coord2$hover <- with(Water_coord2, paste(County, '<br>', "Population", Population, "Average PFAO Concentration", Concentration_Total, "<br>"))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_geo(Water_coord2, locationmode = 'USA-states')
fig <- fig %>% add_trace(
    z = ~Concentration_Total, text = ~hover, locations = ~code,
    color = ~Concentration_Total, colors = 'Blues'
  )
fig <- fig %>% colorbar(title = "PFOA Water Concentrations")
fig <- fig %>% layout(
    title = 'California County Average PFOA Contamination Concentrations in January of 2020',
    geo = g
  )

fig
```

```{r}
leaflet(Water_coord2) %>% 
  addTiles %>%
  addPolygons()
```

