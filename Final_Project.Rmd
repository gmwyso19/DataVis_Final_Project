---
title: "Final Project"
author: "Grace Wysocki"
date: "3/22/2022"
output: html_document
---

Direct information to use in my blog to talk about the data: 

The Safe Drinking Water Act requires EPA to administer a surveillance program to determine the prevalence of unregulated contaminants in finished water provided by community water systems. A number of states and individual public water systems have been testing source water and finished water for PFAS, but these records are not maintained by EPA in a national repository. EPA has provided states that are regulating and/or testing PFAS with a mechanism to store/report PFAS data that is associated with state-specific PFAS regulations. As of January 2021, EPA was able to compile data for eight states that have used EPA’s reporting module (SDWIS-State). The information is retrieved on a semi-annual basis – primarily from state web pages where the information is published. This data file includes aggregated data from multiple state sampling initiatives. These initiatives vary in sampling/targeting methods (e.g., non-targeted analysis vs. targeted analysis), scope (e.g., percentage and type of public water system), detection limits, sample location, reporting limits, quantification methods, what data elements are reported, and even what data are reported (e.g., some states choosing only to report detections while other states report all test results). Because of these significant differences in how states are collecting data, the information in this file should not be compared across state boundaries.

For this reason, I will be focusing on the state of California, as it had a lot of data collected.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("blogdown")
```

```{r}
library(readr)
library(tidyverse)
library(sf)
library(plotly)
Drinking_Water <- read_csv("~/Desktop/Drinking_Water_Testing_Data_State_01-03-2022_0.csv")
#view(Drinking_Water)
```

Tidying the data set to specify it to only include points from California of PFOA during the year 2020.
```{r}
Water_CA <- Drinking_Water %>% group_by(State) %>% filter(State =="CA")
Water_CA <- Water_CA %>% rename(Sample_Date = `Sample Date`) %>% separate(col = Sample_Date, into = c("month", "day", "year"), 
           sep = "/") 
##view(Water_CA)
Water_CA <- Water_CA %>% group_by(year, Contaminant) %>% filter(year == 2020) %>% filter(Contaminant == "PFOA")
#(Water_CA)
```


```{r}

#install.packages("usmap")
library(usmap) 
library(ggplot2) 

plot_usmap(regions = "counties") + 
  theme(panel.background=element_blank())

plot_usmap(include = c("CA")) +
  labs(title = "California Mapping") +
  theme(panel.background = element_rect(color = "black"))

plot_usmap(data = Water_CA, values = "Concentration", include = c("CA"), color = "blue") + 
  scale_fill_continuous(low = "white", high = "blue", name = "PFOA Concentration", label = scales::comma) + 
  labs(title = "California PFOA Mapping", subtitle = "Concentration of PFOA Water Contamination for California Counties in 2020") +
  theme(legend.position = "right")

```


What I learned I actually want to do for this project while working on it 3/27/2022:

- For what I want to accomplish in this project, I need to make an interactive map through leaflet rather than ggplot2. This way I can have users hover over a specific county in California and see the concentration of PFOA for various dates over the year. 


Playing around with leaflet code from  https://rstudio.github.io/leaflet/choropleths.html to see if I can get it to match up with what I am trying to accomplish. I know it doesn't look like much progress but I have been working all class to try to figure out how to use leaflet to make the graph, as I am having trouble understanding leaflet. Hopefully by next class I will have a leaflet graph made so I can start focusing on additional graphics for my blog, and start to add my work to my blog.


Work From 4/2 (Weekend)

```{r}
library(leaflet)
library(sp)

Drinking_Water <- read_csv("~/Desktop/Drinking_Water_Testing_Data_State_01-03-2022_0.csv")

Water_CA <- Drinking_Water %>% group_by(State) %>% filter(State =="CA")
Water_CA <- Water_CA %>% rename(Sample_Date = `Sample Date`) %>% separate(col = Sample_Date, into = c("month", "day", "year"), 
           sep = "/") 
##view(Water_CA)
Water_CA <- Water_CA %>% group_by(year, Contaminant) %>% filter(year == 2020, month == 1) %>% filter(Contaminant == "PFOA")

Water_CA <- Water_CA %>% distinct()

#view(Water_CA)

```

Having trouble trying ot figure out how to map this data as specific latitude and longitudes are now given. Shoud I try to make a column of coordinates based of off county coordinates? (or I mean I probably cannot just add another column to a data set, so I may need to talk to you about that)

Working Lollipop Graph Showing Average Concentrations Drawn in Each County During the Month of January in 2020.
```{r}
Water_CA$Concentration = as.numeric(Water_CA$Concentration)


Water_AVG <- Water_CA%>% ungroup() %>% group_by(County) %>% summarise(Concentration_Total = mean(Concentration)) %>% arrange(desc(Concentration_Total))

#view(Water_AVG)

Water_remove <- Water_AVG[-c(3), ]

#view(Water_remove)

Water_remove <- Water_remove %>% select(County, Concentration_Total) %>%
  arrange(Concentration_Total) %>% mutate(County = factor(County, levels = .$County)) 

ggplot(data = Water_remove, aes(x = County, y = Concentration_Total)) +
  geom_point(size=3, color="blue", fill=alpha("light blue", 0.3), alpha=0.7, shape=21, stroke=1) + 
  geom_segment(aes(x = County, xend = County, y = 0, yend = Concentration_Total)) + geom_text(aes(label = Concentration_Total), hjust = -1) + 
  coord_flip() +
  labs(x = "County Name", 
       y = "Average Concentrations of PFOA(NG/L) Drawn from Each County in January 2020")

```

Working Lollipop Graph of Populations of Each County During the Month of January in 2020.
```{r}
Water_parse <- Water_CA %>% rename(Population_Served = `Population Served`) %>% mutate(Population_Served = parse_number(Population_Served)) 

Water_parse <- Water_parse[-c(93, 114), ]

#view(Water_parse)

Water_Parse <- Water_parse %>% group_by(County) %>% summarise(Population_AVG = mean(Population_Served)) %>% arrange(desc(Population_AVG))

 Water_Parse <- Water_Parse %>% select(County, Population_AVG) %>%
  arrange(Population_AVG) %>% mutate(County = factor(County, levels = .$County)) 
  ggplot(data = Water_Parse, aes(x = County, y = Population_AVG)) +
  geom_point(size=3, color="blue", fill=alpha("light blue", 0.3), alpha=0.7, shape=21, stroke=1) + 
  geom_segment(aes(x = County, xend = County, y = 0, yend = Population_AVG)) + geom_text(aes(label = Population_AVG), hjust = -1) +
  coord_flip() +
  labs(x = "County Name", 
       y = "Population Each County Included in California in January 2020")
```


Scatterplot of Data (this needs adjusting) ### NOT USING IGNORE
```{r}
Water_rename <- Water_remove %>% rename(Population_Served = `Population Served`)

view(Water_fix)
Water_CA$Concentration = as.numeric(Water_CA$Concentration)

ggplot(data = Water_rename, aes(x = Concentration, y = Population_Served)) +
  geom_point() + facet_wrap( ~ County)
```


```{r}
library(usmap)
library(ggplot2)

#view(Water_CA)

Water_Plot <- Water_CA %>% separate(col = County, into = c("County", "State"), 
           sep = ",") 
#view(Water_Plot)

plot_usmap(data = Water_Plot, values = "State", color = "Concentration_Total") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "PFOA Concentration (2020)", label = scales::comma
  ) + theme(legend.position = "right")
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))
```


```{r}

#install.packages("usmap")
library(usmap) 
library(ggplot2) 

plot_usmap(regions = "counties") + 
  theme(panel.background=element_blank())

plot_usmap(include = c("CA")) +
  labs(title = "California Mapping") +
  theme(panel.background = element_rect(color = "black"))

plot_usmap(data = Water_CA, values = "Concentration_Total", include = c("CA"), color = "blue") + 
  scale_fill_continuous(low = "white", high = "blue", name = "PFOA Concentration", label = scales::comma) + 
  labs(title = "California PFOA Mapping", subtitle = "Concentration of PFOA Water Contamination for California Counties in 2020") +
  theme(legend.position = "right")

```


-scatter plot by average(hover that and it tells county name)
-plotly
-maps package in ggplot2

```{r}
Water_rename$Population_Served = as.character(Water_rename$Population_Served)

Water_rename

Water_pop <- Water_rename %>% mutate(Population_lower = Population_Served/1000)

#view(Water_pop)

plot1 <- ggplot(data = Water_rename, aes(x = Concentration, y = Population_Served,
                                   color = County,      
                                   label = County)) +
  geom_point()

ggplotly(plot1, tooltip = "label")

#view(Water_rename)
```

Trying to make population in order

Trying to make interactive map(using leaflet)
```{r}
leaflet() %>% addProviderTiles('CartoDB') %>%
setView(lng = -119.4179, lat = 36.7783, zoom = 4.5)


```

I am still looking for a dataset to join with my water data set that has California state counties as that took up the majority of my time.

Yay! Finally found a data sate to join with my water one that contains U.S. county zipcodes. This did take about an hour and a half to find, so it took up the majority of my work time. 
```{r}
url <- "https://en.wikipedia.org/wiki/User:Michael_J/County_table"

library(tidyverse)
library(rvest)

h <- read_html(url)

tab <- h %>% html_nodes("table")

tab
county_coord <- tab[[1]] %>% html_table(fill = TRUE)

county_coord <- county_coord %>% rename(County = `County [2]`)
county_coord <- county_coord %>% filter(State == "CA")

view(county_coord)

Water_remove <-  Water_remove %>% separate(col = County, into = c("County", "State"), 
           sep = ",") 

Water_County <- full_join(Water_remove,county_coord, by = c("County" = "County"))

view(Water_County)
```

Have them joined but need to figure out how to change the row names of the counties so that they are not all in upper case. Once they are joined fully,I will be able to make my interactive leaflet map which will be my main data visualization for my blog.